<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora Renault</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --text: #0b1220;
            --panel: #ffffff;
            --muted: #6b7280;
            --accent: #66fcf1;
            --danger: #ff4d57;
            --border: #d7dde5;
            --field: #ffffff;
            --chip: #f1f5f9;
            --radius: 14px;
            --gap: 16px;
        }

        body.dark {
            --bg: #0b0c10;
            --text: #e6eef6;
            --panel: #1f2833;
            --muted: #c5c6c7;
            --accent: #66fcf1;
            --danger: #ff4d57;
            --border: #2b3642;
            --field: #12161c;
            --chip: #0f1318;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 22px;
        }

        h1 {
            text-align: center;
            margin: 0 0 12px;
            font-size: 22px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .topbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 8px 0;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
            user-select: none;
            padding: 6px 8px;
            border-radius: 10px;
        }

        .hint {
            text-align: center;
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 24px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--gap);
        }

        .col-4 { grid-column: span 4; }
        .col-6 { grid-column: span 6; }
        .col-12 { grid-column: span 12; }

        @media (max-width: 900px) {
            .col-4, .col-6, .col-12 { grid-column: span 12; }
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 8px;
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--field);
            color: var(--text);
            text-align: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(102, 252, 241, 0.15);
        }

        .chip {
            width: 100%;
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px dashed var(--border);
            background: var(--chip);
            color: var(--muted);
            font-weight: 600;
        }

        .kpi {
            background: var(--field);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 26px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            height: 100%;
            justify-content: center;
        }

        .kpi .label {
            font-size: 13px;
            color: var(--muted);
            font-weight: 500;
        }

        .kpi .value {
            font-size: 36px;
            font-weight: 900;
            color: var(--accent);
            letter-spacing: -1px;
        }

        .kpi.alert .value {
            color: var(--danger);
        }

        .toolbar {
            display: flex;
            justify-content: center;
            margin-top: 24px;
        }

        .btn {
            cursor: pointer;
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #2cc7bf, var(--accent));
            color: #001417;
            font-weight: 700;
            font-size: 15px;
            transition: transform 0.1s;
        }
        
        .btn:active {
            transform: scale(0.98);
        }
    </style>
</head>

<body>
    <div class="topbar">
        <span id="themeToggle" class="theme-toggle" title="Cambiar tema">ðŸŒ™</span>
    </div>
    <div class="wrap">
        <h1>Calculadora Renault</h1>
        <div class="hint">Actualizado: 01.02.2026</div>

        <div class="card" style="margin-bottom:20px">
            <div class="grid">
                <div class="col-6">
                    <label>Modelo</label>
                    <select id="modelo"></select>
                </div>
                <div class="col-6">
                    <label>Plazo</label>
                    <select id="plazo"></select>
                    <div id="rateOptionsContainer" style="margin-top: 12px; display: none;">
                        <label style="margin-bottom: 4px; font-size: 11px; text-align: left; color: var(--muted);">OpciÃ³n de Tasa</label>
                        <select id="rateOption" style="font-size: 14px; padding: 10px; text-align: left;"></select>
                    </div>
                </div>

                <div class="col-4">
                    <label>Valor de la unidad ($)</label>
                    <input id="valorUnidad" type="text" inputmode="numeric" placeholder="Ej: 32.200.000">
                </div>
                <div class="col-4">
                    <label>Monto mÃ¡ximo</label>
                    <input id="montoMax" class="chip" type="text" readonly>
                </div>
                <div class="col-4">
                    <label>Monto solicitado ($)</label>
                    <input id="montoSolicitado" type="text" inputmode="numeric" placeholder="Ej: 12.000.000">
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="col-6">
                <div class="kpi" id="kpiEntrega">
                    <div class="label">Entrega MÃ­nima Estimada</div>
                    <div id="entrega" class="value">â€”</div>
                </div>
            </div>
            <div class="col-6">
                <div class="kpi" id="kpiCuota">
                    <div class="label">Cuota Pura (Sin Seguro)</div>
                    <div id="cuota" class="value">â€”</div>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <button class="btn" onclick="window.print()">Imprimir SimulaciÃ³n</button>
        </div>
    </div>

    <script>
        // Datos embebidos - PolÃ­tica Comercial Febrero 2026 (Convencional)
        const RE_DATA = {
            "Convencional": {
                "Particulares": [
                    { "nombre": "LINEA KWID 16 MARS TASA 0", "modelos": ["Kwid"], "tope": 16000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KWID 12 MARS TASA 0", "modelos": ["Kwid"], "tope": 12000000, "planes": [{ "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }, { "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KWID 10 MARS TASA 0", "modelos": ["Kwid"], "tope": 10000000, "planes": [{ "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KWID", "modelos": ["Kwid"], "tope": 12000000, "planes": [{ "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA LOGAN TASA 0", "modelos": ["Logan"], "tope": 13000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }, { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA LOGAN", "modelos": ["Logan"], "tope": 13000000, "planes": [{ "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA SANDERO", "modelos": ["Sandero"], "tope": 13000000, "planes": [{ "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 }, { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 }, { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA STEPWAY", "modelos": ["Stepway"], "tope": 13000000, "planes": [{ "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 }, { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 }, { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA KVP", "modelos": ["Kangoo VP"], "tope": 13000000, "planes": [{ "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 }, { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 }, { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA DUSTER 15 MARS TASA 0", "modelos": ["Duster"], "tope": 15000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }, { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA DUSTER 15 MARS", "modelos": ["Duster"], "tope": 15000000, "planes": [{ "plazo": 24, "tna": 9.9, "cuota1000": 47.83, "cncCamp": 12.0 }] },
                    { "nombre": "LINEA DUSTER 20 MARS", "modelos": ["Duster"], "tope": 20000000, "planes": [{ "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA KARDIAN 20 MARS TASA 0", "modelos": ["Kardian"], "tope": 20000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KARDIAN 16 MARS TASA 0", "modelos": ["Kardian"], "tope": 16000000, "planes": [{ "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KARDIAN 11 MARS TASA 0", "modelos": ["Kardian"], "tope": 11000000, "planes": [{ "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KARDIAN 20 MARS", "modelos": ["Kardian"], "tope": 20000000, "planes": [{ "plazo": 36, "tna": 34.9, "cuota1000": 51.29, "cncCamp": 12.0 }, { "plazo": 48, "tna": 39.9, "cuota1000": 48.97, "cncCamp": 12.0 }, { "plazo": 60, "tna": 44.9, "cuota1000": 49.92, "cncCamp": 12.0 }] },
                    { "nombre": "LINEA KARDIAN 16 MARS", "modelos": ["Kardian"], "tope": 16000000, "planes": [{ "plazo": 24, "tna": 15.9, "cuota1000": 51.70, "cncCamp": 12.0 }, { "plazo": 36, "tna": 27.9, "cuota1000": 46.19, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },

                    { "nombre": "LINEA KARDIAN EVO 16 MARS TASA 0", "modelos": ["Kardian Evolution"], "tope": 16000000, "planes": [{ "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KARDIAN EVO 12 MARS TASA 0", "modelos": ["Kardian Evolution"], "tope": 12000000, "planes": [{ "plazo": 36, "tna": 0.0, "cuota1000": 27.78, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KARDIAN EVO 16 MARS", "modelos": ["Kardian Evolution"], "tope": 16000000, "planes": [{ "plazo": 36, "tna": 15.9, "cuota1000": 37.89, "cncCamp": 12.0 }] },

                    { "nombre": "LINEA ARKANA 25 MARS TASA O", "modelos": ["Arkana"], "tope": 25000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA ARKANA 20 MARS TASA O", "modelos": ["Arkana"], "tope": 20000000, "planes": [{ "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA ARKANA 25 MARS", "modelos": ["Arkana"], "tope": 25000000, "planes": [{ "plazo": 18, "tna": 14.9, "cuota1000": 64.95, "cncCamp": 12.0 }, { "plazo": 24, "tna": 24.9, "cuota1000": 57.68, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA NUEVO KOLEOS", "modelos": ["Nuevo Koleos"], "tope": 25000000, "planes": [{ "plazo": 12, "tna": 9.9, "cuota1000": 89.60, "cncCamp": 12.0 }, { "plazo": 18, "tna": 14.9, "cuota1000": 64.95, "cncCamp": 12.0 }] }
                ],
                "Utilitarios": [
                    { "nombre": "LINEA OROCH TASA 0", "modelos": ["Oroch"], "tope": 16000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }, { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA OROCH", "modelos": ["Oroch"], "tope": 16000000, "planes": [{ "plazo": 24, "tna": 9.9, "cuota1000": 47.83, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA ALASKAN 22 MARS", "modelos": ["Alaskan"], "tope": 22000000, "planes": [{ "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 }, { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    { "nombre": "LINEA ALASKAN 18 MARS", "modelos": ["Alaskan"], "tope": 18000000, "planes": [{ "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 }, { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }, { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA KVU 16 MARS TASA 0", "modelos": ["Kangoo Express"], "tope": 16000000, "planes": [{ "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 }, { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }, { "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }] },
                    { "nombre": "LINEA KVU 16 MARS", "modelos": ["Kangoo Express"], "tope": 16000000, "planes": [{ "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }] },
                    { "nombre": "LINEA KVU 19 MARS", "modelos": ["Kangoo Express"], "tope": 19000000, "planes": [{ "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 }, { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }] },
                    
                    { "nombre": "LINEA MASTER 13 MARS", "modelos": ["Master"], "tope": 13000000, "planes": [{ "plazo": 12, "tna": 19.9, "cuota1000": 96.07, "cncCamp": 12.0 }, { "plazo": 18, "tna": 29.9, "cuota1000": 74.85, "cncCamp": 12.0 }] },
                    { "nombre": "LINEA MASTER 23 MARS", "modelos": ["Master"], "tope": 23000000, "planes": [{ "plazo": 24, "tna": 39.9, "cuota1000": 68.12, "cncCamp": 12.0 }, { "plazo": 36, "tna": 49.9, "cuota1000": 62.78, "cncCamp": 12.0 }, { "plazo": 48, "tna": 49.9, "cuota1000": 57.17, "cncCamp": 12.0 }, { "plazo": 60, "tna": 49.9, "cuota1000": 54.27, "cncCamp": 12.0 }] }
                ]
            }
        };

        // Referencias a elementos del DOM
        const selModelo = document.getElementById('modelo');
        const selPlazo = document.getElementById('plazo');
        const selRate = document.getElementById('rateOption');
        const rateContainer = document.getElementById('rateOptionsContainer');
        const valUni = document.getElementById('valorUnidad');
        const monMax = document.getElementById('montoMax');
        const monSol = document.getElementById('montoSolicitado');
        const outEnt = document.getElementById('entrega');
        const outCuo = document.getElementById('cuota');
        const kpiCuo = document.getElementById('kpiCuota');

        let dualRatePlans = {};

        // --- Funciones Auxiliares ---

        function fmt(n) {
            if (!n) return 'â€”';
            return `$${Math.round(n).toLocaleString('es-AR', { minimumFractionDigits: 0 })}`;
        }

        function parseNumeric(value) {
            if (!value || value === 'â€”') return 0;
            const cleaned = value.toString().replace('$', '').replace(/\./g, '').replace(/,/g, '.');
            return parseFloat(cleaned);
        }

        function formatInput(inputElement) {
            let value = inputElement.value.replace(/[^\d]/g, '');
            let number = parseInt(value, 10);
            if (isNaN(number)) {
                inputElement.value = '';
                return;
            }
            inputElement.value = number.toLocaleString('es-AR').replace(/,/g, '.');
        }

        function getValues() {
            return {
                modelo: selModelo.value,
                plazo: parseInt(selPlazo.value),
                rateOption: selRate.value,
                precio: parseNumeric(valUni.value),
                creditoReq: parseNumeric(monSol.value),
                limite: parseNumeric(monMax.value)
            };
        }

        // --- LÃ³gica de la Calculadora ---

        function re_modelosDisponibles() {
            // Combinar Particulares y Utilitarios en una lista plana
            const allPlanes = [...RE_DATA.Convencional.Particulares, ...RE_DATA.Convencional.Utilitarios];
            const modelos = new Set();
            allPlanes.forEach(l => l.modelos.forEach(m => modelos.add(m)));
            return Array.from(modelos).sort();
        }

        function re_planesPorModelo(modelo) {
            const allPlanes = [...RE_DATA.Convencional.Particulares, ...RE_DATA.Convencional.Utilitarios];
            return allPlanes.filter(l => l.modelos.includes(modelo));
        }

        function re_plazosDisponibles(modelo) {
            const s = new Set();
            re_planesPorModelo(modelo).forEach(l => l.planes.forEach(p => s.add(p.plazo)));
            return Array.from(s).sort((a, b) => a - b);
        }

        function re_planPara(modelo, plazo) {
            const allLines = re_planesPorModelo(modelo);
            const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));
            if (!linesForPlazo.length) return null;

            // Priorizar mayor tope si hay conflicto, a menos que sea tasa dual gestionada aparte
            const targetLine = linesForPlazo.reduce((a, b) => (a.tope || 0) >= (b.tope || 0) ? a : b);
            
            const plan = targetLine.planes.find(p => p.plazo === plazo);
            if (plan) {
                return { ...plan, tope: targetLine.tope, nombre_linea: targetLine.nombre };
            }
            return null;
        }

        // --- Carga de Opciones ---

        function loadModelos() {
            const modelos = re_modelosDisponibles();
            selModelo.innerHTML = modelos.map(m => `<option value="${m}">${m}</option>`).join('');
            if (modelos.length) selModelo.value = modelos[0];
            loadPlazos();
        }

        function loadPlazos() {
            const { modelo } = getValues();
            rateContainer.style.display = 'none';
            selRate.innerHTML = '';
            dualRatePlans = {}; 
            selPlazo.innerHTML = '';

            if (!modelo) return;

            const plazos = re_plazosDisponibles(modelo);
            selPlazo.innerHTML = plazos.map(p => `<option value="${p}">${p} meses</option>`).join('');

            if (plazos.length) loadRateOptions();
            updateLimite();
            recalc();
        }

        function loadRateOptions() {
            const { modelo, plazo } = getValues();
            rateContainer.style.display = 'none';
            selRate.innerHTML = '';
            dualRatePlans = {};

            const allLines = re_planesPorModelo(modelo);
            const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));

            // Si hay mÃ¡s de una lÃ­nea para este plazo, habilitamos el selector
            if (linesForPlazo.length > 1) {
                const tasa0Line = linesForPlazo.find(l => l.planes.some(p => p.plazo === plazo && p.tna < 1));
                const interesLine = linesForPlazo.find(l => l.planes.some(p => p.plazo === plazo && p.tna >= 1));

                if (tasa0Line && interesLine) {
                    const tasa0Plan = tasa0Line.planes.find(p => p.plazo === plazo);
                    const interesPlan = interesLine.planes.find(p => p.plazo === plazo);

                    dualRatePlans.tasa0 = { ...tasa0Plan, tope: tasa0Line.tope, nombre_linea: tasa0Line.nombre };
                    dualRatePlans.interes = { ...interesPlan, tope: interesLine.tope, nombre_linea: interesLine.nombre };

                    rateContainer.style.display = 'block';

                    const t0Text = `Tasa 0% (MÃ¡x: ${fmt(tasa0Line.tope).replace('$', '')})`;
                    selRate.innerHTML += `<option value="tasa0">${t0Text}</option>`;

                    const intText = `TNA ${interesPlan.tna.toFixed(1)}% (MÃ¡x: ${fmt(interesLine.tope).replace('$', '')})`;
                    selRate.innerHTML += `<option value="interes">${intText}</option>`;

                    checkInterestOption();
                }
            }
        }

        function checkInterestOption() {
            const { creditoReq } = getValues();
            const kpiCuo = document.getElementById('kpiCuota');
            if (!dualRatePlans.tasa0 || !dualRatePlans.interes) return;

            const tasa0Plan = dualRatePlans.tasa0;
            const interestOption = selRate.querySelector('option[value="interes"]');

            if (creditoReq > tasa0Plan.tope) {
                if (interestOption) selRate.value = 'interes';
                kpiCuo.classList.remove('alert');
            }
        }

        function updateLimite() {
            const { modelo, plazo, rateOption } = getValues();
            if (!modelo || !plazo) {
                monMax.value = 'â€”';
                return;
            }

            let tope = 0;
            if (dualRatePlans.tasa0 && dualRatePlans.interes) {
                if (rateOption === 'tasa0') tope = dualRatePlans.tasa0.tope;
                else if (rateOption === 'interes') tope = dualRatePlans.interes.tope;
                else tope = dualRatePlans.interes.tope;
            } else {
                const allLines = re_planesPorModelo(modelo);
                const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));
                if (linesForPlazo.length) {
                    const linea = linesForPlazo.reduce((a, b) => (a.tope || 0) >= (b.tope || 0) ? a : b);
                    tope = linea.tope;
                }
            }
            monMax.value = fmt(tope);
        }

        function recalc() {
            const { modelo, plazo, precio, creditoReq, limite, rateOption } = getValues();
            const kpiCuo = document.getElementById('kpiCuota');

            if (!modelo || !plazo || isNaN(precio) || isNaN(creditoReq)) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                kpiCuo.classList.remove('alert');
                return;
            }

            const over = limite > 0 && creditoReq > limite;
            if (over) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                kpiCuo.classList.add('alert');
                return;
            } else {
                kpiCuo.classList.remove('alert');
            }

            let plan = null;
            if (dualRatePlans.tasa0 && dualRatePlans.interes && rateOption) {
                plan = dualRatePlans[rateOption];
            } else {
                plan = re_planPara(modelo, plazo);
            }

            if (!plan) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                return;
            }

            const creditoBruto = Math.min(creditoReq, plan.tope || 0);
            const cnc = creditoBruto * ((plan.cncCamp || 0) / 100) * 1.21;
            const entrega = (precio - creditoBruto) + cnc;
            const cuota = plan.cuota1000 * (creditoBruto / 1000);

            outEnt.textContent = fmt(entrega);
            outCuo.textContent = fmt(cuota);
        }

        function init() {
            loadModelos();
            recalc();
        }

        // Eventos
        selModelo.addEventListener('change', () => { 
            loadPlazos(); 
        });

        selPlazo.addEventListener('change', () => { 
            loadRateOptions(); 
            updateLimite(); 
            recalc(); 
        });

        selRate.addEventListener('change', () => { 
            updateLimite(); 
            recalc(); 
        });

        valUni.addEventListener('input', () => {
            formatInput(valUni);
            recalc();
        });

        monSol.addEventListener('input', () => {
            formatInput(monSol);
            checkInterestOption();
            updateLimite();
            recalc();
        });

        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        });

        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.remove('dark');
            document.body.classList.add('light');
        } else {
            document.body.classList.add('dark');
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
