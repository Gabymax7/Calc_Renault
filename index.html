<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Calculadora de CrÃ©dito Â· Multimarca</title>
    <style>
        :root {
            --bg: #f6f8fb;
            --text: #0b1220;
            --panel: #ffffff;
            --muted: #6b7280;
            --accent: #66fcf1;
            --danger: #ff4d57;
            --border: #d7dde5;
            --field: #ffffff;
            --chip: #f1f5f9;
            --radius: 14px;
            --gap: 16px;
        }

        body.dark {
            --bg: #0b0c10;
            --text: #e6eef6;
            --panel: #1f2833;
            --muted: #c5c6c7;
            --accent: #66fcf1;
            --danger: #ff4d57;
            --border: #2b3642;
            --field: #12161c;
            --chip: #0f1318;
        }

        * {
            box-sizing: border-box;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
        }

        body {
            margin: 0;
            background: var(--bg);
            color: var(--text);
        }

        .wrap {
            max-width: 1100px;
            margin: 0 auto;
            padding: 22px;
        }

        h1 {
            text-align: center;
            margin: 0 0 12px;
            font-size: 22px;
        }

        .topbar {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding: 10px 8px 0;
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 22px;
            line-height: 1;
            user-select: none;
            padding: 6px 8px;
            border-radius: 10px;
        }

        .hint {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 12px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 18px;
            padding: 18px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: var(--gap);
        }

        .col-3 {
            grid-column: span 3;
        }

        .col-4 {
            grid-column: span 4;
        }

        .col-6 {
            grid-column: span 6;
        }

        .col-12 {
            grid-column: span 12;
        }

        @media (max-width: 900px) {

            .col-3,
            .col-4,
            .col-6,
            .col-12 {
                grid-column: span 12;
            }
        }

        label {
            display: block;
            font-size: 12px;
            color: var(--muted);
            margin-bottom: 6px;
            text-align: center;
        }

        input,
        select {
            width: 100%;
            padding: 12px 14px;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            background: var(--field);
            color: var(--text);
            text-align: center;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .chip {
            width: fit-content;
            min-width: 160px;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px dashed var(--border);
            background: var(--chip);
            margin: 0 auto;
        }

        .kpi {
            background: var(--field);
            border: 1px dashed var(--border);
            border-radius: 18px;
            padding: 26px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .kpi .label {
            font-size: 12px;
            color: var(--muted);
        }

        .kpi .value {
            font-size: 32px;
            font-weight: 900;
            color: var(--accent);
        }

        .kpi.alert .value {
            color: var(--danger);
        }

        .toolbar {
            display: flex;
            justify-content: center;
            margin-top: 16px;
        }

        .btn {
            cursor: pointer;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border);
            background: linear-gradient(90deg, #2cc7bf, var(--accent));
            color: #001417;
        }
    </style>
</head>

<body>
    <div class="topbar">
        <span id="themeToggle" class="theme-toggle" title="Cambiar tema">ðŸŒ™</span>
    </div>
    <div class="wrap">
        <h1>Calculadora de CrÃ©dito Â· Multimarca</h1>
        <div class="hint">Actualizado: 04.12.2025. Renault: tope por lÃ­nea/plazo; CNC en efectivo + IVA incluido en Entrega.</div>

        <div class="card" style="margin-bottom:16px">
            <div class="grid">
                <div class="col-4">
                    <label>Marca</label>
                    <select id="marca"></select>
                </div>
                <div class="col-4">
                    <label>Modelo</label>
                    <select id="modelo"></select>
                </div>
                <div class="col-4">
                    <label>Plazo</label>
                    <select id="plazo"></select>
                    <div id="rateOptionsContainer" style="margin-top: 10px; display: none;">
                        <label style="margin-bottom: 2px; font-size: 11px; text-align: left; color: var(--text);">OpciÃ³n
                            de
                            Tasa</label>
                        <select id="rateOption" style="font-size: 14px; padding: 8px 10px; text-align: left;">
                        </select>
                    </div>
                </div>

                <div class="col-6">
                    <label>Valor de la unidad ($)</label>
                    <input id="valorUnidad" type="text" inputmode="numeric" placeholder="Ej: 32.200.000">
                </div>
                <div class="col-3">
                    <label>Monto mÃ¡ximo</label>
                    <input id="montoMax" class="chip" type="text" readonly>
                </div>
                <div class="col-3">
                    <label>Monto solicitado ($)</label>
                    <input id="montoSolicitado" type="text" inputmode="numeric" placeholder="Ej: 12.000.000">
                </div>
            </div>
        </div>

        <div class="grid">
            <div class="col-6">
                <div class="kpi" id="kpiEntrega">
                    <div class="label">Entrega</div>
                    <div id="entrega" class="value">â€”</div>
                </div>
            </div>
            <div class="col-6">
                <div class="kpi" id="kpiCuota">
                    <div class="label">Cuota estimada (sin seguro)</div>
                    <div id="cuota" class="value">â€”</div>
                </div>
            </div>
        </div>

        <div class="toolbar" style="margin-bottom:14px">
            <button class="btn" onclick="window.print()">Imprimir</button>
        </div>
    </div>

    <script>
        // Datos embebidos - Actualizados PolÃ­tica Comercial 04.12.2025
        const RE_DATA = {
            "Convencional": {
                "Particulares": [
                    {
                        "nombre": "LINEA KWID 12 MARS TASA 0",
                        "modelos": ["Kwid"],
                        "tope": 12000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LINEA KWID 10 MARS TASA O",
                        "modelos": ["Kwid"],
                        "tope": 10000000,
                        "planes": [
                             { "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LINEA KWID",
                        "modelos": ["Kwid"],
                        "tope": 12000000,
                        "planes": [
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea LOGAN TASA 0",
                        "modelos": ["Logan"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea LOGAN",
                        "modelos": ["Logan"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea SANDERO",
                        "modelos": ["Sandero"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 },
                            { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 },
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea STEPWAY",
                        "modelos": ["Stepway"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 },
                            { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 },
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea KVP",
                        "modelos": ["Kangoo VP"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 },
                            { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 },
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea DUSTER 15 MARS TASA 0",
                        "modelos": ["Duster"],
                        "tope": 15000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea DUSTER 15 MARS",
                        "modelos": ["Duster"],
                        "tope": 15000000,
                        "planes": [
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea DUSTER 20 MARS",
                        "modelos": ["Duster"],
                        "tope": 20000000,
                        "planes": [
                            { "plazo": 36, "tna": 34.9, "cuota1000": 51.29, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LINEA KARDIAN 16 MARS TASA O",
                        "modelos": ["Kardian"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LINEA KARDIAN 11 MARS TASA O",
                        "modelos": ["Kardian"],
                        "tope": 11000000,
                        "planes": [
                            { "plazo": 24, "tna": 0.0, "cuota1000": 41.67, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LINEA KARDIAN",
                        "modelos": ["Kardian"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea ARKANA 20 MARS TASA 0",
                        "modelos": ["Arkana"],
                        "tope": 20000000,
                        "planes": [
                            { "plazo": 9, "tna": 0.0, "cuota1000": 111.11, "cncCamp": 9.0 },
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea ARKANA 25 MARS",
                        "modelos": ["Arkana"],
                        "tope": 25000000,
                        "planes": [
                            { "plazo": 18, "tna": 19.9, "cuota1000": 68.20, "cncCamp": 12.0 },
                            { "plazo": 24, "tna": 29.9, "cuota1000": 61.09, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea NUEVO KOLEOS",
                        "modelos": ["Koleos", "Nuevo Koleos"],
                        "tope": 25000000,
                        "planes": [
                            { "plazo": 12, "tna": 9.9, "cuota1000": 89.60, "cncCamp": 12.0 },
                            { "plazo": 18, "tna": 14.9, "cuota1000": 64.95, "cncCamp": 12.0 }
                        ]
                    }
                ],
                "Utilitarios": [
                    {
                        "nombre": "LÃ­nea OROCH TASA 0",
                        "modelos": ["Oroch"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea OROCH",
                        "modelos": ["Oroch"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea ALASKAN 22 MARS",
                        "modelos": ["Alaskan"],
                        "tope": 22000000,
                        "planes": [
                            { "plazo": 12, "tna": 4.9, "cuota1000": 86.42, "cncCamp": 12.0 },
                            { "plazo": 24, "tna": 14.9, "cuota1000": 51.05, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea ALASKAN 18 MARS",
                        "modelos": ["Alaskan"],
                        "tope": 18000000,
                        "planes": [
                            { "plazo": 18, "tna": 9.9, "cuota1000": 61.74, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea KVU 16 MARS TASA 0",
                        "modelos": ["Kangoo Express"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 12, "tna": 0.0, "cuota1000": 83.33, "cncCamp": 9.0 },
                            { "plazo": 18, "tna": 0.0, "cuota1000": 55.56, "cncCamp": 9.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea KVU 16 MARS",
                        "modelos": ["Kangoo Express"],
                        "tope": 16000000,
                        "planes": [
                            { "plazo": 24, "tna": 9.9, "cuota1000": 47.83, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 29.9, "cuota1000": 47.63, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea KVU 19 MARS",
                        "modelos": ["Kangoo Express"],
                        "tope": 19000000,
                        "planes": [
                            { "plazo": 48, "tna": 34.9, "cuota1000": 45.02, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 34.9, "cuota1000": 41.53, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea MASTER 13 MARS",
                        "modelos": ["Master"],
                        "tope": 13000000,
                        "planes": [
                            { "plazo": 12, "tna": 19.9, "cuota1000": 96.07, "cncCamp": 12.0 },
                            { "plazo": 18, "tna": 29.9, "cuota1000": 74.85, "cncCamp": 12.0 }
                        ]
                    },
                    {
                        "nombre": "LÃ­nea MASTER 23 MARS",
                        "modelos": ["Master"],
                        "tope": 23000000,
                        "planes": [
                            { "plazo": 24, "tna": 39.9, "cuota1000": 68.12, "cncCamp": 12.0 },
                            { "plazo": 36, "tna": 49.9, "cuota1000": 62.78, "cncCamp": 12.0 },
                            { "plazo": 48, "tna": 49.9, "cuota1000": 57.17, "cncCamp": 12.0 },
                            { "plazo": 60, "tna": 49.9, "cuota1000": 54.27, "cncCamp": 12.0 }
                        ]
                    }
                ]
            }
        };

        // Referencias a elementos del DOM
        const selMarca = document.getElementById('marca');
        const selModelo = document.getElementById('modelo');
        const selPlazo = document.getElementById('plazo');
        const selRate = document.getElementById('rateOption');
        const rateContainer = document.getElementById('rateOptionsContainer');
        const valUni = document.getElementById('valorUnidad');
        const monMax = document.getElementById('montoMax');
        const monSol = document.getElementById('montoSolicitado');
        const outEnt = document.getElementById('entrega');
        const outCuo = document.getElementById('cuota');
        const kpiCuo = document.getElementById('kpiCuota');

        // Estado global para las opciones de tasa dual
        let dualRatePlans = {};


        // --- Funciones Auxiliares ---

        function fmt(n) {
            if (!n) return 'â€”';
            return `$${Math.round(n).toLocaleString('es-AR', { minimumFractionDigits: 0 })}`;
        }

        function parseNumeric(value) {
            if (!value || value === 'â€”') return 0;
            // Elimina el signo de pesos y los separadores de miles
            const cleaned = value.toString().replace('$', '').replace(/\./g, '').replace(/,/g, '.');
            return parseFloat(cleaned);
        }

        function formatInput(inputElement) {
            let value = inputElement.value.replace(/[^\d]/g, '');
            let number = parseInt(value, 10);

            if (isNaN(number)) {
                inputElement.value = '';
                return;
            }

            inputElement.value = number.toLocaleString('es-AR').replace(/,/g, '.');
        }

        function getValues() {
            return {
                marca: selMarca.value,
                modelo: selModelo.value,
                plazo: parseInt(selPlazo.value),
                rateOption: selRate.value,
                precio: parseNumeric(valUni.value),
                creditoReq: parseNumeric(monSol.value),
                limite: parseNumeric(monMax.value)
            };
        }

        // --- LÃ³gica de la Calculadora Renault ---

        function re_modelosDisponibles() {
            const modelos = new Set();
            Object.keys(RE_DATA.Convencional).forEach(cat => {
                RE_DATA.Convencional[cat].forEach(l => l.modelos.forEach(m => modelos.add(m)));
            });
            return Array.from(modelos).sort();
        }

        function re_planesPorModelo(modelo) {
            const lines = [];
            Object.keys(RE_DATA.Convencional).forEach(cat => {
                lines.push(...RE_DATA.Convencional[cat].filter(l => l.modelos.includes(modelo)));
            });
            return lines;
        }

        function re_plazosDisponibles(modelo) {
            const s = new Set();
            re_planesPorModelo(modelo).forEach(l => l.planes.forEach(p => s.add(p.plazo)));
            return Array.from(s).sort((a, b) => a - b);
        }

        function re_planPara(modelo, plazo, nombre_linea = null) {
            const allLines = re_planesPorModelo(modelo);
            let targetLine = null;

            if (nombre_linea) {
                targetLine = allLines.find(l => l.nombre === nombre_linea);
            } else {
                const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));
                if (!linesForPlazo.length) return null;
                // Si hay mÃºltiples lÃ­neas para el mismo plazo (sin especificar nombre), priorizamos la que tiene mayor tope.
                // Esto es un fallback, la lÃ³gica principal se maneja en loadRateOptions para casos duales.
                targetLine = linesForPlazo.reduce((a, b) => (a.tope || 0) >= (b.tope || 0) ? a : b);
            }

            if (targetLine) {
                const plan = targetLine.planes.find(p => p.plazo === plazo);
                if (plan) {
                    return { ...plan, tope: targetLine.tope, nombre_linea: targetLine.nombre };
                }
            }

            return null;
        }

        // --- Funciones de Carga de Opciones ---

        function loadMarcas() {
            selMarca.innerHTML = ['Renault'].map(m => `<option value="${m}">${m}</option>`).join('');
            localStorage.setItem('calc_marca', 'Renault');
        }

        function loadModelos() {
            const modelos = re_modelosDisponibles();
            selModelo.innerHTML = modelos.map(m => `<option value="${m}">${m}</option>`).join('');
            if (modelos.length) selModelo.value = modelos[0];
        }

        function loadPlazos() {
            const { modelo } = getValues();

            // Limpiar opciones de tasa y ocultar contenedor al cambiar de modelo o plazo
            rateContainer.style.display = 'none';
            selRate.innerHTML = '';
            dualRatePlans = {}; 
            selPlazo.innerHTML = '';


            if (!modelo) {
                return;
            }

            const plazos = re_plazosDisponibles(modelo);
            selPlazo.innerHTML = plazos.map(p => `<option value="${p}">${p} meses</option>`).join('');

            if (plazos.length) {
                loadRateOptions();
            }
        }

        /**
         * Verifica si existen mÃºltiples planes (ej: Tasa 0 vs Tasa InterÃ©s) para el mismo plazo.
         */
        function loadRateOptions() {
            const { modelo, plazo } = getValues();
            rateContainer.style.display = 'none';
            selRate.innerHTML = '';
            dualRatePlans = {};

            const allLines = re_planesPorModelo(modelo);
            
            // Buscar si para el plazo seleccionado existen planes con Tasa 0 (o muy baja) y planes con Tasa Alta
            const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));

            // Si hay mÃ¡s de una lÃ­nea para este plazo, habilitamos el selector
            if (linesForPlazo.length > 1) {
                // Identificamos Tasa 0 y Tasa InterÃ©s (asumimos Tasa 0 es < 1%)
                const tasa0Line = linesForPlazo.find(l => l.planes.some(p => p.plazo === plazo && p.tna < 1));
                const interesLine = linesForPlazo.find(l => l.planes.some(p => p.plazo === plazo && p.tna >= 1));

                if (tasa0Line && interesLine) {
                    const tasa0Plan = tasa0Line.planes.find(p => p.plazo === plazo);
                    const interesPlan = interesLine.planes.find(p => p.plazo === plazo);

                    dualRatePlans.tasa0 = { ...tasa0Plan, tope: tasa0Line.tope, nombre_linea: tasa0Line.nombre };
                    dualRatePlans.interes = { ...interesPlan, tope: interesLine.tope, nombre_linea: interesLine.nombre };

                    rateContainer.style.display = 'block';

                    const t0Text = `Tasa 0% (MÃ¡x: ${fmt(tasa0Line.tope).replace('$', '')})`;
                    selRate.innerHTML += `<option value="tasa0">${t0Text}</option>`;

                    const intText = `TNA ${interesPlan.tna.toFixed(1)}% (MÃ¡x: ${fmt(interesLine.tope).replace('$', '')})`;
                    selRate.innerHTML += `<option value="interes">${intText}</option>`;

                    // Verificar si el monto solicitado obliga a cambiar la opciÃ³n
                    checkInterestOption();
                }
            }
        }

        function checkInterestOption() {
            const { creditoReq } = getValues();
            const kpiCuo = document.getElementById('kpiCuota');

            // Solo aplica si tenemos opciones duales cargadas
            if (!dualRatePlans.tasa0 || !dualRatePlans.interes) {
                return;
            }

            const tasa0Plan = dualRatePlans.tasa0;
            const interestOption = selRate.querySelector('option[value="interes"]');

            if (creditoReq > tasa0Plan.tope) {
                // Monto excede el lÃ­mite de Tasa 0%: Forzar selecciÃ³n a InterÃ©s si es posible
                if (interestOption) {
                    selRate.value = 'interes';
                    // Opcional: deshabilitar la opciÃ³n de tasa 0 visualmente si se desea
                }
                kpiCuo.classList.remove('alert');
            } else {
                // Si el usuario estaba en interes forzado pero ahora baja el monto, 
                // NO forzamos volver a Tasa 0 automÃ¡ticamente para no molestar, 
                // pero permitimos que el usuario elija.
            }
        }

        /**
         * Actualiza el campo de Monto MÃ¡ximo (monMax).
         */
        function updateLimite() {
            const { modelo, plazo, rateOption } = getValues();
            if (!modelo || !plazo) {
                monMax.value = 'â€”';
                return;
            }

            let tope = 0;

            // LÃ³gica para Tasa Dual
            if (dualRatePlans.tasa0 && dualRatePlans.interes) {
                if (rateOption === 'tasa0') {
                    tope = dualRatePlans.tasa0.tope;
                } else if (rateOption === 'interes') {
                    tope = dualRatePlans.interes.tope;
                } else {
                    // Default fallback
                    tope = dualRatePlans.interes.tope;
                }
            } else {
                // LÃ³gica estÃ¡ndar
                const allLines = re_planesPorModelo(modelo);
                const linesForPlazo = allLines.filter(l => l.planes.some(p => p.plazo === plazo));
                
                if (linesForPlazo.length) {
                    // Si hay conflicto de lÃ­neas (que no sea tasa dual capturada arriba), tomamos el tope mayor por seguridad
                    const linea = linesForPlazo.reduce((a, b) => (a.tope || 0) >= (b.tope || 0) ? a : b);
                    tope = linea.tope;
                }
            }

            monMax.value = fmt(tope);
        }

        // --- FunciÃ³n Principal de RecÃ¡lculo ---

        function recalc() {
            const { marca, modelo, plazo, precio, creditoReq, limite, rateOption } = getValues();
            const kpiCuo = document.getElementById('kpiCuota');

            if (marca !== 'Renault' || !modelo || !plazo || isNaN(precio) || isNaN(creditoReq)) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                kpiCuo.classList.remove('alert');
                return;
            }

            // 1. Verificar si el monto solicitado supera el monto mÃ¡ximo activo
            const over = limite > 0 && creditoReq > limite;
            if (over) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                kpiCuo.classList.add('alert');
                return;
            } else {
                kpiCuo.classList.remove('alert');
            }

            let plan = null;

            // SelecciÃ³n de plan (Dual o EstÃ¡ndar)
            if (dualRatePlans.tasa0 && dualRatePlans.interes && rateOption) {
                plan = dualRatePlans[rateOption];
            } else {
                plan = re_planPara(modelo, plazo);
            }

            if (!plan) {
                outEnt.textContent = 'â€”';
                outCuo.textContent = 'â€”';
                return;
            }

            // 2. CÃ¡lculo de Entrega y Cuota
            // El crÃ©dito bruto en la fÃ³rmula financiera no debe exceder el tope, 
            // aunque ya validamos que creditoReq <= limite, aseguramos:
            const creditoBruto = Math.min(creditoReq, plan.tope || 0);
            
            // CÃ¡lculo CNC: (Monto * %CNC) + IVA(21%) sobre ese costo
            // La polÃ­tica dice "Aporte CNC x%". Usualmente es neto, luego se suma IVA.
            const cnc = creditoBruto * ((plan.cncCamp || 0) / 100) * 1.21; 
            
            const entrega = (precio - creditoBruto) + cnc;
            const cuota = plan.cuota1000 * (creditoBruto / 1000);

            outEnt.textContent = fmt(entrega);
            outCuo.textContent = fmt(cuota);
        }

        // --- InicializaciÃ³n y Eventos ---

        function init() {
            loadMarcas();
            loadModelos();
            loadPlazos();
            updateLimite();
            recalc();
        }

        // Eventos 
        selMarca.addEventListener('change', () => { localStorage.setItem('calc_marca', selMarca.value); loadModelos(); loadPlazos(); updateLimite(); recalc(); });
        selModelo.addEventListener('change', () => { loadPlazos(); updateLimite(); recalc(); });
        selPlazo.addEventListener('change', () => { loadRateOptions(); updateLimite(); recalc(); });

        // Eventos de entrada con formato de miles
        valUni.addEventListener('input', () => {
            formatInput(valUni);
            updateLimite();
            recalc();
        });
        
        monSol.addEventListener('input', () => {
            formatInput(monSol);
            checkInterestOption(); // Valida si el monto fuerza cambio de tasa (ej. Arkana > 20M)
            updateLimite();        // Actualiza el tope visual si cambiÃ³ la tasa
            recalc();              
        });

        selRate.addEventListener('change', () => { updateLimite(); recalc(); });

        // Evento para el tema (Dark/Light Mode)
        document.getElementById('themeToggle').addEventListener('click', () => {
            document.body.classList.toggle('dark');
            localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
        });

        // Cargar tema guardado
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.remove('dark'); // Por defecto estÃ¡ dark en CSS
            document.body.classList.add('light'); // O simplemente quitar dark si usas variable
        } else {
            document.body.classList.add('dark');
        }

        // Inicializar la calculadora
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>

</html>
